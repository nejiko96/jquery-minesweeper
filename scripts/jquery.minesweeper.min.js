/*! jquery.minesweeper - v1.4.2 - 2015-05-24
* https://github.com/nejiko96/jquery-minesweeper#readme
* Copyright (c) 2015 nejiko96 <nejiko2006@gmail.com>; Licensed MIT */
!function(a){var b=function(a){this._init(a)};a.extend(b,{_EVENT_BUTTON_LEFT:1,_EVENT_BUTTON_RIGHT:2,_EVENT_BUTTON_BOTH:3,_EVENT_WHICH_LEFT:1,_EVENT_WHICH_RIGHT:3,_DEFAULT_SETTINGS:{onCellLeftMouseDown:a.noop,onCellRightMouseDown:a.noop,onCellBothMouseDown:a.noop,onCellLeftMouseOver:a.noop,onCellRightMouseOver:a.noop,onCellBothMouseOver:a.noop,onCellLeftMouseOut:a.noop,onCellRightMouseOut:a.noop,onCellBothMouseOut:a.noop,onCellLeftMouseUp:a.noop,onCellRightMouseUp:a.noop,onCellBothMouseUp:a.noop}}),a.extend(b.prototype,{_init:function(c){this._settings=a.extend({},b._DEFAULT_SETTINGS,c||{}),this._buttonKey=0;var d=this;a(document).mouseup(function(){d._buttonKey=0})},_reset:function(){this._triggers=this._settings},_stop:function(){this._triggers=b._DEFAULT_SETTINGS},_onCellMouseDown:function(a,c){var d=0;void 0!==a.button?d=0===a.button?b._EVENT_BUTTON_LEFT:a.button&b._EVENT_BUTTON_BOTH:void 0!==a.which&&(d=a.which===b._EVENT_WHICH_LEFT?b._EVENT_BUTTON_LEFT:a.which===b._EVENT_WHICH_RIGHT?b._EVENT_BUTTON_RIGHT:0),this._buttonKey|=d,this._buttonKey===b._EVENT_BUTTON_LEFT?this._triggers.onCellLeftMouseDown(c):this._buttonKey===b._EVENT_BUTTON_RIGHT?this._triggers.onCellRightMouseDown(c):this._buttonKey===b._EVENT_BUTTON_BOTH&&this._triggers.onCellBothMouseDown(c)},_onCellMouseOver:function(a,c){0!==this._buttonKey&&(this._buttonKey===b._EVENT_BUTTON_LEFT?this._triggers.onCellLeftMouseOver(c):this._buttonKey===b._EVENT_BUTTON_RIGHT?this._triggers.onCellRightMouseOver(c):this._buttonKey===b._EVENT_BUTTON_BOTH&&this._triggers.onCellBothMouseOver(c))},_onCellMouseOut:function(a,c){0!==this._buttonKey&&(this._buttonKey===b._EVENT_BUTTON_LEFT?this._triggers.onCellLeftMouseOut(c):this._buttonKey===b._EVENT_BUTTON_RIGHT?this._triggers.onCellRightMouseOut(c):this._buttonKey===b._EVENT_BUTTON_BOTH&&this._triggers.onCellBothMouseOut(c))},_onCellMouseUp:function(a,c){if(0!==this._buttonKey){var d=this._buttonKey;this._buttonKey=0,d===b._EVENT_BUTTON_LEFT?this._triggers.onCellLeftMouseUp(c):d===b._EVENT_BUTTON_RIGHT?this._triggers.onCellRightMouseUp(c):d===b._EVENT_BUTTON_BOTH&&this._triggers.onCellBothMouseUp(c)}}});var c=function(a,b){this._init(a,b)};a.extend(c.prototype,{_init:function(a,b){this._cells=a,this._setMine=b},_generate:function(b,c){var d=this;for(this._reserved=a.extend([],c),this._reserved.push("."),this._emptyCells=this._cells-c.length;b>0;--b)d._insert()},_insert:function(){var b=this,c=Math.floor(Math.random()*this._emptyCells);a.each(this._reserved,function(a,d){return"."===d||d>c?(b._reserved.splice(a,0,c),b._emptyCells--,b._setMine(c),!1):void++c})}});var d=function(a,b){this._init(a,b)};a.extend(d,{_STATE_CLASS:"minesweeper-state",_STATE_HIDDEN:"0",_STATE_NOT_MARKED:"01",_STATE_FLAGGED:"0f",_STATE_UNCERTAIN:"0h",_STATE_OPENED:"1",_STATE_VACANT:"10",_STATE_MINE:"19",_STATE_EXPLOSION:"1a",_STATE_MISTAKE:"1b",_HAS_MINE:1,_HAS_FLAG:2}),a.extend(d.prototype,{_init:function(c,e){this._$cells=c;var f=new Array(this._$cells.length+1).join('"'+d._STATE_NOT_MARKED+'",');this._initStates="["+f.slice(0,-1)+"]";var g=new b(e);this._$cells.each(function(b){a(this).mousedown(function(a){g._onCellMouseDown(a,b)}).mouseover(function(a){g._onCellMouseOver(a,b)}).mouseout(function(a){g._onCellMouseOut(a,b)}).mouseup(function(a){g._onCellMouseUp(a,b)})}),this._listener=g},_reset:function(){this._states=a.parseJSON(this._initStates),this._$cells.removeClass().addClass(d._STATE_CLASS+d._STATE_NOT_MARKED),this._mineFlags={},this._listener._reset(),this._started=!1},_start:function(a,b){var e=this;new c(this._$cells.length,function(a){e._setMineFlag(a,d._HAS_MINE)})._generate(a,b),this._started=!0},_stop:function(){this._listener._stop()},_getState:function(a){return this._states[a]},_setState:function(a,b){this._states[a]=b,this._$cells.eq(a).removeClass().addClass(d._STATE_CLASS+b)},_isHidden:function(a){return this._getState(a).charAt(0)===d._STATE_HIDDEN},_isNotMarked:function(a){return this._getState(a)===d._STATE_NOT_MARKED},_isFlagged:function(a){return this._getState(a)===d._STATE_FLAGGED},_isUncertain:function(a){return this._getState(a)===d._STATE_UNCERTAIN},_isOpened:function(a){return this._getState(a).charAt(0)===d._STATE_OPENED},_getMineCount:function(a){return parseInt(this._getState(a),10)-10},_setNotMarked:function(a){this._setState(a,d._STATE_NOT_MARKED)},_setFlagged:function(a){this._setState(a,d._STATE_FLAGGED),this._setMineFlag(a,d._HAS_FLAG)},_setUncertain:function(a){this._setState(a,d._STATE_UNCERTAIN),this._unsetMineFlag(a,d._HAS_FLAG)},_setMineCount:function(a,b){this._setState(a,d._STATE_OPENED+b)},_setMine:function(a){this._setState(a,d._STATE_MINE)},_setExplosion:function(a){this._setState(a,d._STATE_EXPLOSION)},_setMistake:function(a){this._setState(a,d._STATE_MISTAKE)},_isFixed:function(a){var b=this._getState(a);return b===d._STATE_NOT_MARKED?!1:b===d._STATE_UNCERTAIN?!1:!0},_press:function(a){this._isFixed(a)||this._$cells.eq(a).removeClass().addClass(d._STATE_CLASS+d._STATE_VACANT)},_release:function(a){if(!this._isFixed(a)){var b=this._getState(a);this._$cells.eq(a).removeClass().addClass(d._STATE_CLASS+b)}},_getMineFlag:function(a){var b=this._mineFlags[a];return void 0===b?0:b},_hasMine:function(a){return this._getMineFlag(a)&d._HAS_MINE},_setMineFlag:function(a,b){void 0===this._mineFlags[a]?this._mineFlags[a]=b:this._mineFlags[a]|=b},_unsetMineFlag:function(a,b){void 0!==this._mineFlags[a]&&(this._mineFlags[a]&=~b,this._mineFlags[a]||delete this._mineFlags[a])},_eachMineFlag:function(b){a.each(this._mineFlags,b)}});var e=function(a,b){this._init(a,b)};a.extend(e,{_DEFAULT_LEVELS:{easy:{width:9,height:9,mines:10},medium:{width:16,height:16,mines:40},hard:{width:30,height:16,mines:99},custom:{}},_WIDTH_MIN:9,_HEIGHT_MIN:9,_WIDTH_MAX:30,_HEIGHT_MAX:24,_MINES_MIN:10,_TIMER_UPDATE_INTERVAL:"1s",_TIMER_MAX_COUNT:999}),a.extend(e.prototype,{_init:function(b,c){this._$target=a(b),this._settings=c,this._initSize()},_initSize:function(){if(a.extend(this._settings,e._DEFAULT_LEVELS[this._settings.level]||{}),this._width=parseInt(this._settings.width,10),isFinite(this._width)?(this._width<e._WIDTH_MIN&&(this._width=e._WIDTH_MIN),this._width>e._WIDTH_MAX&&(this._width=e._WIDTH_MAX)):this._width=e._WIDTH_MIN,this._height=parseInt(this._settings.height,10),isFinite(this._height)?(this._height<e._HEIGHT_MIN&&(this._height=e._HEIGHT_MIN),this._height>e._HEIGHT_MAX&&(this._height=e._HEIGHT_MAX)):this._height=e._HEIGHT_MIN,this._cells=this._width*this._height,this._mines=parseInt(this._settings.mines,10),isFinite(this._mines)){this._mines<e._MINES_MIN&&(this._mines=e._MINES_MIN);var b=Math.floor(this._width*this._height*.94-8.45);this._mines>b&&(this._mines=b)}else{var c=10+Math.floor(this._cells/45);this._mines=10*Math.round(this._cells*c/1e3)}},_show:function(){var a=this;this._$target.html(this._generateHtml()),this._board=new d(this._$target.find(".minesweeper-cells > span"),{onCellLeftMouseDown:function(b){a._onCellLeftMouseDown(b)},onCellLeftMouseOver:function(b){a._onCellLeftMouseOver(b)},onCellLeftMouseOut:function(b){a._onCellLeftMouseOut(b)},onCellLeftMouseUp:function(b){a._onCellLeftMouseUp(b)},onCellRightMouseDown:function(b){a._onCellRightMouseDown(b)},onCellBothMouseDown:function(b){a._onCellBothMouseDown(b)},onCellBothMouseOver:function(b){a._onCellBothMouseOver(b)},onCellBothMouseOut:function(b){a._onCellBothMouseOut(b)},onCellBothMouseUp:function(b){a._onCellBothMouseUp(b)}}),this._$txtMines=this._$target.find(".minesweeper-mines"),this._$txtTimer=this._$target.find(".minesweeper-timer"),this._$btnRestart=this._$target.find(".minesweeper-restart"),this._$txtMines.before(this._settings.minesTextBefore),this._$txtMines.after(this._settings.minesTextAfter),this._$txtTimer.before(this._settings.timerTextBefore),this._$txtTimer.after(this._settings.timerTextAfter),this._$btnRestart.text(this._settings.restartText),this._$btnRestart.click(function(){a._resetGame()}),this._resetGame()},_generateHtml:function(){var a,b="";for(b+="<form>",b+="<nobr>",b+='<span class="minesweeper-mines" ></span>',b+="&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;",b+='<span class="minesweeper-timer" ></span>',b+='<div class="minesweeper-cells" >',a=0;a<this._cells;a++)a>0&&a%this._width===0&&(b+="<br />"),b+="<span></span>";return b+="</div>",b+='<button type="button" class="minesweeper-restart" ></button>',b+="</nobr>",b+="</form>"},_onCellLeftMouseDown:function(a){this._board._press(a)},_onCellLeftMouseOver:function(a){this._board._press(a)},_onCellLeftMouseOut:function(a){this._board._release(a)},_onCellLeftMouseUp:function(a){return this._board._started||this._startGame(a),this._board._isFixed(a)?void 0:this._board._hasMine(a)?(this._explosion.push(a),void this._gameOver()):void this._openSafe(a)},_onCellRightMouseDown:function(a){var b;this._board._isOpened(a)||(this._board._isNotMarked(a)?(this._board._setFlagged(a),b=parseInt(this._$txtMines.text(),10),this._$txtMines.text(b-1)):this._board._isFlagged(a)?(this._board._setUncertain(a),b=parseInt(this._$txtMines.text(),10),this._$txtMines.text(b+1)):this._board._isUncertain(a)&&this._board._setNotMarked(a))},_onCellBothMouseDown:function(b){var c=this;a.each(this._neighbors(b),function(a,b){c._board._press(b)})},_onCellBothMouseOver:function(b){var c=this;a.each(this._neighbors(b),function(a,b){c._board._press(b)})},_onCellBothMouseOut:function(b){var c=this;a.each(this._neighbors(b),function(a,b){c._board._release(b)})},_onCellBothMouseUp:function(b){var c=this;if(a.each(this._neighbors(b),function(a,b){c._board._release(b)}),!this._board._isHidden(b)){var e=this._board._getMineCount(b),f=0,g=[],h=[];a.each(this._surroundings(b),function(a,b){if(!c._board._isOpened(b)){var e=c._board._getMineFlag(b);return e&d._HAS_FLAG?void f++:e&d._HAS_MINE?void h.push(b):void g.push(b)}}),f===e&&(a.each(g,function(a,b){c._openSafe(b)}),h.length>0&&(this._explosion=h,this._gameOver()))}},_resetGame:function(){a.timer&&this._$txtTimer.stopTime(),this._$txtTimer.text("0"),this._unopened=this._cells-this._mines,this._explosion=[],this._board._reset(),this._$txtMines.text(this._mines)},_startGame:function(b){this._board._start(this._mines,this._neighbors(b)),a.timer&&(this._$txtTimer.text("1"),this._$txtTimer.everyTime(e._TIMER_UPDATE_INTERVAL,function(){a(this).text(a(this).text()-0+1)},e._TIMER_MAX_COUNT-1))},_stopGame:function(){a.timer&&this._$txtTimer.stopTime(),this._board._stop()},_gameClear:function(){var a=this;this._stopGame(),this._board._eachMineFlag(function(b,c){c===d._HAS_MINE&&a._board._setFlagged(b)}),this._$txtMines.text("0"),alert(this._settings.clearedText)},_gameOver:function(){var b=this;this._stopGame(),this._board._eachMineFlag(function(a,c){c===d._HAS_MINE?b._board._setMine(a):c===d._HAS_FLAG&&b._board._setMistake(a)}),a.each(this._explosion,function(a,c){b._board._setExplosion(c)})},_openSafe:function(b){if(!this._board._isOpened(b)){var c=this,e=0,f=[];return a.each(this._surroundings(b),function(a,b){if(!c._board._isOpened(b)){var g=c._board._getMineFlag(b);return g&d._HAS_MINE?void e++:void(g&d._HAS_FLAG||f.push(b))}}),this._board._setMineCount(b,e),this._unopened--,this._unopened<=0?void this._gameClear():void(0===e&&a.each(f,function(a,b){c._openSafe(b)}))}},_surroundings:function(a){return this._neighbors(a,!0)},_neighbors:function(b,c){var d=this,e=[],f=b%this._width,g=b-f;return a.each([g-d._width,g,g+d._width],function(b,h){0>h||h>=d._cells||a.each([f-1,f,f+1],function(a,b){c&&h===g&&b===f||0>b||b>=d._width||e.push(h+b)})}),e}}),a.minesweeper={},a.minesweeper.version="1.4.2",a.minesweeper.defaults={level:"easy"},a.minesweeper.regional={},a.minesweeper.regional[""]={minesTextBefore:"",minesTextAfter:"mines",timerTextBefore:"time : ",timerTextAfter:"",restartText:"Retry",clearedText:"Cleared!"},a.extend(a.minesweeper.defaults,a.minesweeper.regional[""]),a.fn.minesweeper=function(b){var c=a.extend({},a.minesweeper.defaults,b||{});return a(this).each(function(){a(this).bind("contextmenu selectstart",function(){return!1}),new e(this,c)._show()})}}(jQuery);